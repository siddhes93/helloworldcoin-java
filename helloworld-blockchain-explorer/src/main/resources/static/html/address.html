<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <title>区块详情-HelloworldBlockchain</title>
        <script src="../lib/jquery/jquery-1.12.4.min.js"></script>
        <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@3.3.7/dist/css/bootstrap.min.css">
        <link rel="stylesheet" href="../assets/common/reset.css">
        <link rel="stylesheet" href="../assets/common/common.css">
        <link rel="stylesheet" href="../assets/css/block.css">
        <link rel="stylesheet" href="../assets/css/transaction.css">
        <link rel="stylesheet" href="../assets/css/address.css">
        <script src="../lib/bootstrap/bootstrap.min.js"></script>
        <script src="../assets/common/common.js"></script>
    </head>
    <body>
        <nav class="navbar navbar-default nav">
            <div class="container-fluid">
                <div class="navbar-header">
                    <a class="navbar-brand" href="./index.html">HelloworldBlockchain</a>
                </div>

                <div class="collapse navbar-collapse" id="bs-example-navbar-collapse-1">
                    <ul class="nav navbar-nav">
                        <li><a href="./node-management.html">节点管理</a></li>
                        <li><a href="./account-management.html">账户管理</a></li>
                        <li><a href="./transfer.html">支付</a></li>
                        <li><a href="./more-management.html">更多管理</a></li>
                    </ul>
                </div>
            </div>
        </nav>
        <div class="box">
            <div class="panel panel-default">
                <div class="panel-heading fwb"></div>
                <button type="button" class="btn btn-default btn-lg Summary">摘要</button>
                <table id="Last10BlockTable" class="table mb-0">
                    <thead>
                        <tr class="fwb lt">
                            <th class="das col-md-6 w100"><span>地址 : </span><span class="address"></span></th>
                            <th class="lf col-md-6"><span>总收入 : </span><span class="fr pr-100 receipt"></span></th>
                        </tr>
                        <tr class="fwb">
                            <th class="das"><span>余额 : </span><span class="balance"></span></th>
                            <th class="lf"><span>总支出 : </span><span class="fr pr-100 spend"></span></th>
                        </tr>
                        
                    </thead>
                </table>
            </div>
            
        </div>

        <p class="diap">
            <button type="button" class="btn btn-default btn-lg">交易</button>
            <button type="button" class="btn btn-default btn-lg">未花费的交易输出【余额】</button>
            <button type="button" class="btn btn-default btn-lg">交易输出【收入】</button>
            <button type="button" class="btn btn-default btn-lg">已花费的交易输出【支出】</button>
        </p>
        <div class="container"></div>
        
        <script>
            let urlParameters = new Map(location.search.slice(1).split('&').map(kv => kv.split('=')))
            let size = 1;
            $(async function(){
                const data = await $ajax({
                    url : "http://119.3.57.171/Api/Blockchain/QueryAccountDetailByAddress",
                    data:`{"address":"${urlParameters.get("address")}"}`
                });
                const { address, balance, receipt, spend  } = data.result;
                $('.address').text(address);
                $('.panel-heading').text('地址 : ' + address);
                $('.receipt').text(receipt);
                $('.spend').text(spend);
                $('.balance').text(balance);
            }());
            $('.diap button').click(async function(){
                size = 1;
                $('.container').empty();
                if($(this).index() === 0){
                    const data = await $ajax({
                        url : "http://119.3.57.171:80/Api/Blockchain/QueryTransactionListByAddress",
                        data:`{
                            "address":"1PL1LHRmEACMQxns2aSic65ip7yQBmUush",
                            "pageCondition":{
                                "from":0,
                                "size":${size}
                            }
                        }`
                    });
                    const transactionViewList = data.result.transactionViewList;
                    transactionViewList.forEach(item => {
                        let res = '';
                        item.transactionInputViewList.forEach(item => {
                            res += `<li class="das">
                                <div>
                                    <span class="mr25">${item.address}</span>
                                    <i class="glyphicon-euro"></i>&nbsp;&nbsp;&nbsp;&nbsp;<span>${item.value}</span>
                                </div>
                            </li>`
                        })
                        let res2 = ''
                        item.transactionOutputViewList.forEach(item1 => {
                            res2 += `
                            <li class="das">
                                <div><span class="mr25">${item1.address}</span><i class="glyphicon-euro"></i>&nbsp;&nbsp;&nbsp;&nbsp;<span>${item1.value}</span></div>
                            </li>
                            `
                        });
                        $('.container').append(`
                            <ul class="list fwb mt-25">
                                <!-- 开头 -->
                            <li class="tou">
                                <span class="f7">${item.transactionHash}</span>
                                <span class="f3">${item.transactionType}</span>
                                <span class="f2">${item.transactionFee}</span>
                                <span class="f1">${item.blockTime}</span>
                            </li>
                            <li class="surface">
                                <ul class="left">${res}</ul>
                                <ul class="right">${res2}</ul>
                            </li>
                        </ul>
                        ${item.transactionOutputViewList ? '<div class="page"><button onclick="load(0)">加载更多</button></div>' : ''}`)
                    })
                    
                }else if($(this).index() === 1){
                    const data = await $ajax({
                        url : "http://119.3.57.171:80/Api/Blockchain/QuerySpendTransactionOutputListByAddress",
                        data:`{
                            "address":"1PL1LHRmEACMQxns2aSic65ip7yQBmUush",
                            "pageCondition":{
                                "from":0,
                                "size":${size}
                            }
                        }`
                    });
                    let {transactionOutputDetailViewList} = data.result;
                    $('.container').append(`<table class="table table-hover tac"></table>${transactionOutputDetailViewList.length ? '<div class="page"><button onclick="load(1)">加载更多</button></div>' : ''}`)
                    transactionOutputDetailViewList.forEach(item => {
                        $('.container .table').append(`
                        <tr class="mt-50">
                            <td class="tdborder">交易哈希 : ${item.blockHash}</td>
                            <td class="tdborder">交易输出索引号 : ${item.transactionOutputIndex}</td>
                            <td class="tdborder">去向 : ${item.transactionHash}</td>
                        </tr>
                        `)
                    })
                }else if($(this).index() === 2){
                    const data = await $ajax({
                        url : "http://119.3.57.171:80/Api/Blockchain/QueryTransactionOutputListByAddress",
                        data:`{
                            "address":"1PL1LHRmEACMQxns2aSic65ip7yQBmUush",
                            "pageCondition":{
                                "from":0,
                                "size":${size}
                            }
                        }`
                    });
                    let {transactionOutputDetailViewList} = data.result;
                    $('.container').append(`<table class="table table-hover tac"> </table>
                    ${transactionOutputDetailViewList.length ? '<div class="page"><button onclick="load(2)">加载更多</button></div>' : ''}`)
                    transactionOutputDetailViewList.forEach(item => {
                        $('.container .table').append(`
                        <tr class="mt-50">
                            <td class="tdborder">交易哈希 : ${item.blockHash}</td>
                            <td class="tdborder">交易输出索引号 : ${item.transactionOutputIndex}</td>
                            <td class="tdborder">去向 : ${item.transactionHash}</td>
                        </tr>
                        `)
                    })
                }else{

                    const data = await $ajax({
                        url : "http://119.3.57.171:80/Api/Blockchain/QuerySpendTransactionOutputListByAddress",
                        data:`{
                            "address":"1PL1LHRmEACMQxns2aSic65ip7yQBmUush",
                            "pageCondition":{
                                "from":0,
                                "size":${size}
                            }
                        }`
                    });
                    let {transactionOutputDetailViewList} = data.result;
                    $('.container').append(`<table class="table table-hover tac"></table>${transactionOutputDetailViewList.length ? '<div class="page"><button onclick="load(3)">加载更多</button></div>' : ''}`)
                    transactionOutputDetailViewList.forEach(item => {
                        $('.container .table').append(`
                        <tr class="mt-50">
                            <td class="tdborder">交易哈希 : ${item.blockHash}</td>
                            <td class="tdborder">交易输出索引号 : ${item.transactionOutputIndex}</td>
                            <td class="tdborder">去向 : ${item.transactionHash}</td>
                        </tr>
                        `)
                    })
                }
            })
            async function load(index){
                size ++;
                if(index === 0){
                    const data = await $ajax({
                        url : "http://119.3.57.171:80/Api/Blockchain/QuerySpendTransactionOutputListByAddress",
                        data:`{
                            "address":"1PL1LHRmEACMQxns2aSic65ip7yQBmUush",
                            "pageCondition":{
                                "from":0,
                                "size":${size}
                            }
                        }`
                    });
                    let {transactionOutputDetailViewList} = data.result;
                    transactionOutputDetailViewList.forEach(item => {
                        $('.container .table').append(`
                        <tr class="mt-50">
                            <td class="tdborder">交易哈希 : ${item.blockHash}</td>
                            <td class="tdborder">交易输出索引号 : ${item.transactionOutputIndex}</td>
                            <td class="tdborder">去向 : ${item.transactionHash}</td>
                        </tr>
                        `)
                    })
                }else if(index === 1){
                    const data = await $ajax({
                        url : "http://119.3.57.171:80/Api/Blockchain/QuerySpendTransactionOutputListByAddress",
                        data:`{
                            "address":"1PL1LHRmEACMQxns2aSic65ip7yQBmUush",
                            "pageCondition":{
                                "from":0,
                                "size":${size}
                            }
                        }`
                    });
                    let {transactionOutputDetailViewList} = data.result;
                    transactionOutputDetailViewList.forEach(item => {
                        $('.container .table').append(`
                        <tr class="mt-50">
                            <td class="tdborder">交易哈希 : ${item.blockHash}</td>
                            <td class="tdborder">交易输出索引号 : ${item.transactionOutputIndex}</td>
                            <td class="tdborder">去向 : ${item.transactionHash}</td>
                        </tr>
                        `)
                    })
                }else if(index === 2){
                    const data = await $ajax({
                        url : "http://119.3.57.171:80/Api/Blockchain/QuerySpendTransactionOutputListByAddress",
                        data:`{
                            "address":"1PL1LHRmEACMQxns2aSic65ip7yQBmUush",
                            "pageCondition":{
                                "from":0,
                                "size":${size}
                            }
                        }`
                    });
                    let {transactionOutputDetailViewList} = data.result;
                    transactionOutputDetailViewList.forEach(item => {
                        $('.container .table').append(`
                        <tr class="mt-50">
                            <td class="tdborder">交易哈希 : ${item.blockHash}</td>
                            <td class="tdborder">交易输出索引号 : ${item.transactionOutputIndex}</td>
                            <td class="tdborder">去向 : ${item.transactionHash}</td>
                        </tr>
                        `)
                    })
                }else{


                    const data = await $ajax({
                        url : "http://119.3.57.171:80/Api/Blockchain/QuerySpendTransactionOutputListByAddress",
                        data:`{
                            "address":"1PL1LHRmEACMQxns2aSic65ip7yQBmUush",
                            "pageCondition":{
                                "from":0,
                                "size":${size}
                            }
                        }`
                    });


                    transactionOutputDetailViewList.forEach(item => {
                        $('.container .table').append(`
                        <tr class="mt-50">
                            <td class="tdborder">交易哈希 : ${item.blockHash}</td>
                            <td class="tdborder">交易输出索引号 : ${item.transactionOutputIndex}</td>
                            <td class="tdborder">去向 : ${item.transactionHash}</td>
                        </tr>
                        `)
                    })


                }
            }
        </script>
    </body>
</html>
