<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <title>区块详情-HelloworldBlockchain</title>
        <script src="../lib/jquery/jquery-1.12.4.min.js"></script>
        <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@3.3.7/dist/css/bootstrap.min.css">
        <link rel="stylesheet" href="../assets/common/reset.css">
        <link rel="stylesheet" href="../assets/common/common.css">
        <link rel="stylesheet" href="../assets/css/block.css">
        <link rel="stylesheet" href="../assets/css/transaction.css">
        <link rel="stylesheet" href="../assets/css/address.css">
        <link rel="stylesheet" href="../assets/css/node-management.css">
        <link rel="stylesheet" href="../assets/css/more-management.css">
        <script src="../lib/bootstrap/bootstrap.min.js"></script>
        <script src="../assets/common/common.js"></script>
    </head>
    <body>
        <nav class="navbar navbar-default nav">
            <div class="container-fluid">
                <div class="navbar-header">
                    <a class="navbar-brand" href="./index.html">HelloworldBlockchain</a>
                </div>

                <div class="collapse navbar-collapse"
                    id="bs-example-navbar-collapse-1">
                    <ul class="nav navbar-nav">
                        <li><a href="./node-management.html">节点管理</a></li>
                        <li><a href="./account-management.html">账户管理</a></li>
                        <li><a href="./transfer.html">支付</a></li>
                        <li><a href="./more-management.html">更多管理</a></li>
                    </ul>
                </div>
            </div>
        </nav>
        <ul class="list fwb mt-50">
            <li class="surface">
                <span>当前区块高度：<em class="num"></em> </span>
                <div>
                    <button class="btn btn-primary btn-lg" type="submit" onclick="clickdeldte()">删除</button>
                </div>
            </li>
            <li class="surface">
                <span>挖矿状态：<em class="status"></em></span>
                <div>
                    <button class="btn btn-primary btn-lg isopen" type="submit" onclick="clickOpen()"></button>
                </div>
            </li>
            <li class="surface">
                <span>同步区块状态：<em class="synchronize"></em></span>
                <div>
                    <button class="btn btn-primary btn-lg sr" type="submit"></button>
                </div>
            </li>
            <li class="surface">
                <span>节点搜寻策略：<em class="dong"></em> </span>
                <div>
                    <button class="btn btn-primary btn-lg am" type="submit"></button>
                </div>
            </li>
        </ul>
        <script>
            let minerInActiveState, synchronizerInActiveState,autoSearchNewNode;
            $(async function(){
                const data = await $ajax({
                    url : "http://119.3.57.171/Api/Blockchain/QueryBlockchainHeight"
                });
                $('.num').text(data.result.blockchainHeight);
            }());
            $(async function(){
                const data = await $ajax({
                    url : "http://119.3.57.171/Api/AdminConsole/IsMinerActive",
                    data:`{}`
                });
                minerInActiveState = data.result.minerInActiveState;
                $('.status').text(data.result.minerInActiveState ? '挖矿中' : '休息中');
                $('.isopen').text(data.result.minerInActiveState ? '停止挖矿' : '开启挖矿');
            }());
            $(async function(){
                const data = await $ajax({
                    url : "http://119.3.57.171/Api/AdminConsole/IsSynchronizerActive",
                    data:`{}`
                });
                synchronizerInActiveState = data.result.synchronizerInActiveState;
                $('.synchronize').text(data.result.synchronizerInActiveState ? '休息中 ' : '同步中')
                $('.sr').text(data.result.synchronizerInActiveState ? '开启同步' : '停止同步')
            }());
            $(async function(){
                const data = await $ajax({
                    url : "http://119.3.57.171/Api/AdminConsole/IsAutoSearchNode",
                    data:`{}`
                });
                autoSearchNewNode = data.result.autoSearchNewNode;
                $('.dong').text(data.result.autoSearchNewNode ? '自动寻找' : '手动添加');
                $('.am').text(data.result.autoSearchNewNode ? '手动添加' : '自动寻找');
            }());
            async function clickdeldte(){
                let res = prompt('删除区块');
                const data = await $ajax({
                    url : "http://119.3.57.171/Api/AdminConsole/DeleteBlock",
                    data:`{
                        "blockHeight":"${res}"
                    }`
                });
                location.reload();
            };
            async function clickOpen(){
                if(minerInActiveState){
                    await $ajax({
                        url : "http://119.3.57.171/Api/AdminConsole/DeactiveMiner",
                        data:"{}"
                    });
                }else{
                    await $ajax({
                        url : "http://119.3.57.171/Api/AdminConsole/ActiveMiner",
                        data:"{}"
                    });
                }
                location.reload();
            }
            $('.sr').click(async function(){
                if(!synchronizerInActiveState){
                    await $ajax({
                        url : "http://119.3.57.171/Api/AdminConsole/ActiveSynchronizer",
                        data:"{}"
                    });
                }else{
                    await $ajax({
                        url : "http://119.3.57.171/Api/AdminConsole/DeactiveSynchronizer",
                        data:"{}"
                    });
                }
                location.reload();
            })
            $('.am').click(async function(){
                console.log(!autoSearchNewNode);
                await $ajax({
                    url : "http://119.3.57.171/Api/AdminConsole/SetAutoSearchNode",
                    data:`{"autoSearchNode": ${!autoSearchNewNode}}`
                });
                location.reload();
            })
        </script>
    </body>
</html>
